#include <stdio.h>
#include <string.h>
#include <omnetpp.h>

class Txc : public cSimpleModule
{
    private:
        cMessage *tictocMsg;
        cMessage *event;
        bool ack;

    public:
        Txc();
        virtual ~Txc();

    protected:
        virtual void initialize();                  // This initializes
        virtual void handleMessage(cMessage *msg);  // This does the hard work
        const char* generateMessageTo(int to);      // This creates the message
        bool isMine(cMessage *msg);                 // This check if the message was sent to me
        bool isLost(cMessage *msg);                 // This checks if a message was lost
        int replyTo(cMessage *msg);                 // This figures out who I should reply to

};

Define_Module(Txc);

Txc::Txc()
{
    // Let's start nice and clean
    event = NULL;
    tictocMsg = NULL;
    ack = false;
}

Txc::~Txc()
{
    // Cleaning up when you are done is always a good thing
    cancelAndDelete(event);
    delete tictocMsg;
}

void Txc::initialize()
{
    // Who am I?
    int me = par("me");
    event = new cMessage("event");

    if (me == 1)
    {
        // I'm the one who has to get everything going

        EV << "Let's get going, I'll just send a message to 3, but only in like 5 seconds, don't want to be over earger";
        tictocMsg = new cMessage(generateMessageTo(3));
        scheduleAt(5.0, event);
    }
}

void Txc::handleMessage(cMessage *msg)
{
      EV << "So I just got this message:  " << msg << "\n";
      simtime_t delay = par("delayTime");

      // Check if I'm allowed to send my message
      if(msg == event)
      {
          EV << "It's the event message, thus I can forward that message I almost forgot about\n";

          // Randomly loose the message
          if (uniform(0,1) < 0.1)
          {
              EV << "Darn it, I lost the message! I'm in so much trouble now, better just tell everyone, so we can try again\n";
              tictocMsg = new cMessage("Lost");
          }

          // Send it
          send(tictocMsg,"out");
      }
      else
      {
          EV << "I can't send yet, but let's see what I received\n";

          // Check if message was lost
          if(isLost(msg))
          {
              EV << "Ah someone lost a message\n";
              if(ack)
              {
                  // My message was lost, re-send
                  EV << "My message was lost, I'll just re-send it\n";
                  tictocMsg = new cMessage(generateMessageTo(replyTo(msg)));
              }
              else
              {
                  // Not my message, pass it on
                  EV << "It was not my message, better tell someone, maybe it was important\n";
                  tictocMsg = msg;
              }
          }
          else
          {
              if(isMine(msg))
              {
                  // The message was mine, I should reply
                  EV << "The message was for me, so I'll reply... later, in like "<< delay << " seconds\n";
                  tictocMsg = new cMessage(generateMessageTo(replyTo(msg)));

                  // Just to remember that I sent a message, I better get a reply
                  ack = true;
              }
              else
              {
                  // Not my message, pass it on
                  EV << "The message was not for me, but I'll pass it on... when I get to it, in "<< delay << " seconds\n";
                  tictocMsg = msg;
                  ack = false;
              }
          }

          // Send it later
          scheduleAt(simTime()+delay, event);
      }
}

const char* Txc::generateMessageTo(int to)
{
    int me = par("me");
    char buffer[5];
    std::string msg = "r";
    msg = msg + itoa(me,buffer,10);
    msg = msg + "r";
    msg = msg + itoa(to,buffer,10);
    return msg.c_str();
}

bool Txc::isMine(cMessage *msg)
{
    std::string msgstring = msg->getFullName();
    int who = msgstring[msgstring.size()-1] - '0';
    int me =  par("me");

    EV << "I am " << me << "\n";

    if(me == who)
    {
        return true;
    }
    else
    {
        return false;
    }
}

bool Txc::isLost(cMessage *msg)
{
    std::string msgstring = msg->getFullName();

    if(msgstring.compare("Lost") != 0)
    {
        return false;
    }
    else
    {
        return true;
    }
}

int Txc::replyTo(cMessage *msg)
{
    std::string msgstring = msg->getFullName();
    return msgstring[2] - '0';
}
